name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
            features: macos
            homebrew_os: darwin
            homebrew_arch: amd64
          - target: aarch64-apple-darwin
            os: macos-latest
            features: macos
            homebrew_os: darwin
            homebrew_arch: arm64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            features: linux
            use-cross: true
            homebrew_os: linux
            homebrew_arch: amd64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            features: linux
            use-cross: true
            homebrew_os: linux
            homebrew_arch: arm64
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            features: linux
            use-cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            features: linux
            use-cross: true

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          ./.github/versions.sh "${GITHUB_REF#refs/tags/}"
        shell: bash

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Setup cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cli
          key: ${{ matrix.target }}

      - name: Build binary
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --no-default-features --features ${{ matrix.features }}
          else
            cargo build --release --target ${{ matrix.target }} --no-default-features --features ${{ matrix.features }}
          fi
        shell: bash

      - name: Prepare release artifacts
        run: |
          cd target/${{ matrix.target }}/release
          
          if [ -n "${{ matrix.homebrew_os }}" ]; then
            ARCHIVE_NAME="jolt-${{ env.VERSION }}-${{ matrix.homebrew_os }}-${{ matrix.homebrew_arch }}"
            mkdir -p "${ARCHIVE_NAME}"
            cp jolt "${ARCHIVE_NAME}/"
            tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
            shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"
          fi
          
          BINARY_NAME="jolt-${{ env.VERSION }}-${{ matrix.target }}"
          cp jolt "${BINARY_NAME}"
          shasum -a 256 "${BINARY_NAME}" > "${BINARY_NAME}.sha256"
        shell: bash

      - name: Upload binary to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/${{ matrix.target }}/release/jolt-${{ env.VERSION }}-${{ matrix.target }}
            target/${{ matrix.target }}/release/jolt-${{ env.VERSION }}-${{ matrix.target }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Homebrew archive to release
        if: matrix.homebrew_os != ''
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/${{ matrix.target }}/release/jolt-${{ env.VERSION }}-${{ matrix.homebrew_os }}-${{ matrix.homebrew_arch }}.tar.gz
            target/${{ matrix.target }}/release/jolt-${{ env.VERSION }}-${{ matrix.homebrew_os }}-${{ matrix.homebrew_arch }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-checksums:
    name: Publish checksums manifest
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*.sha256"
          out-file-path: checksums

      - name: Create checksums manifest
        run: |
          cd checksums
          cat *.sha256 > ../checksums.txt
          cd ..
          cat checksums.txt

      - name: Upload checksums manifest
        uses: softprops/action-gh-release@v1
        with:
          files: checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew-releaser:
    name: Update Homebrew formula
    needs: build
    runs-on: ubuntu-latest
    if: ${{ !github.event.release.prerelease }}
    steps:
      - name: Release to Homebrew tap
        uses: Justintime50/homebrew-releaser@v3
        with:
          homebrew_owner: jordond
          homebrew_tap: homebrew-tap
          github_token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          commit_owner: github-actions[bot]
          commit_email: github-actions[bot]@users.noreply.github.com
          install: 'bin.install "jolt"'
          test: 'assert_match version.to_s, shell_output("#{bin}/jolt --version")'
          target_darwin_amd64: true
          target_darwin_arm64: true
          target_linux_amd64: true
          target_linux_arm64: true

  publish-crates:
    name: Publish to crates.io
    needs: build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update version from tag
        run: ./.github/versions.sh "${GITHUB_REF#refs/tags/}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish crates
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CRATE_TOKEN }}
          args: --allow-dirty

  update-version:
    name: Update version in main
    needs: [build, publish-checksums, homebrew-releaser, publish-crates]
    if: ${{ always() && needs.build.result == 'success' && needs.publish-checksums.result == 'success' && needs.publish-crates.result == 'success' && (needs.homebrew-releaser.result == 'success' || needs.homebrew-releaser.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version
        run: ./.github/versions.sh "${GITHUB_REF#refs/tags/}"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml
          git diff --staged --quiet || git commit -m "chore: bump version to ${{ github.event.release.tag_name }}"
          git push
